<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GEARCALC-PRO — NN-based STE (Metallic Spur Gears)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b33; --text:#e8eefc; --muted:#aeb8d6;
      --line:rgba(255,255,255,.10); --accent:#7aa2ff; --good:#52ffa8; --bad:#ff6b6b; --warn:#ffcc66;
      --shadow:0 12px 36px rgba(0,0,0,.35); --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:var(--sans);
      background:
        radial-gradient(1200px 900px at 15% -10%, rgba(122,162,255,.20), transparent 60%),
        radial-gradient(900px 700px at 95% 0%, rgba(61,220,151,.10), transparent 55%),
        linear-gradient(180deg, #070c16, var(--bg) 45%, #070c16);
    }
    .app{display:grid; grid-template-columns:360px 1fr; gap:16px; padding:16px; min-height:100vh;}
    @media (max-width:1200px){ .app{grid-template-columns:1fr;} .sidebar{position:static} }

    .sidebar{position:sticky; top:16px; align-self:start; display:flex; flex-direction:column; gap:14px;}
    .main{display:flex; flex-direction:column; gap:16px; min-width:0;}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden;
    }
    .head{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
      background:rgba(255,255,255,.02);
    }
    .head h2{margin:0; font-size:13px; font-weight:800; letter-spacing:.02em}
    .body{padding:12px 14px}
    .brand .lab{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em}
    .brand .title{font-size:21px; font-weight:800; line-height:1.1; margin-top:4px}
    .brand .subtitle{font-size:12px; color:var(--muted); line-height:1.35; margin-top:6px}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted); line-height:1.2}
    .field input{
      width:100%; background:rgba(0,0,0,.22); color:var(--text);
      border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px;
      outline:none; font-size:13px;
    }
    .field input:focus{
      border-color:rgba(122,162,255,.55);
      box-shadow:0 0 0 3px rgba(122,162,255,.18);
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--text);
      border-radius:12px; padding:10px 12px; font-weight:700; font-size:13px; cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{background:rgba(122,162,255,.18); border-color:rgba(122,162,255,.42)}
    .btn.good{background:rgba(61,220,151,.12); border-color:rgba(61,220,151,.35)}

    .status{
      padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20); font-size:13px; color:var(--muted); line-height:1.35;
    }
    .status.ok{border-color:rgba(82,255,168,.28)}
    .status.warn{border-color:rgba(255,204,102,.35)}
    .status.bad{border-color:rgba(255,107,107,.35)}
    .mono{font-family:var(--mono)}

    .badgeRow{display:flex; gap:10px; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); font-size:13px; color:var(--muted);
    }
    .badge strong{color:var(--text); font-family:var(--mono)}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:16px; min-width:0}
    @media (max-width:1200px){ .split{grid-template-columns:1fr;} }

    .canvasWrap{padding:12px; display:flex; flex-direction:column; gap:10px}
    canvas{
      width:100%; height:430px; display:block; border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.12));
    }
    .smallnote{font-size:12px; color:var(--muted); line-height:1.35}
    .kv{
      display:grid; grid-template-columns:1fr auto; gap:10px 14px; font-size:13px;
      padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.10);
    }
    .kv:last-child{border-bottom:none}
    .kv .k{color:var(--muted)}
    .kv .v{color:var(--text); font-family:var(--mono)}
    .hint{
      padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02); font-size:12px; color:var(--muted); line-height:1.35;
    }
    .footer{color:rgba(255,255,255,.55); font-size:12px; padding:0 2px 2px}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <section class="card">
      <div class="body">
        <div class="brand">
          <div class="lab">Machine Design Laboratory — NTUA</div>
          <div class="title">GEARCALC-PRO — NN-based STE Demo (Metal)</div>
          <div class="subtitle">
            Frontend-only page that calls a Python backend API to run your existing
            <span class="mono">NN_single_call.py</span> and returns the MATLAB-equivalent outputs/plots.
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head"><h2>Backend API</h2></div>
      <div class="body">
        <div class="field">
          <label>API Base URL (Render/Railway/etc.)</label>
          <input id="apiBase" type="text" value="http://127.0.0.1:8000" />
        </div>
        <div class="hint" style="margin-top:10px;">
          Για GitHub Pages βάλε εδώ το URL του Python backend σου (π.χ. Render service).
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head"><h2>NN Inputs (same as MATLAB defaults)</h2></div>
      <div class="body">
        <div class="grid">
          <div class="field"><label>x_vals_pop</label><input id="x_vals_pop" type="number" step="1" value="1000"></div>
          <div class="field"><label>sy [MPa]</label><input id="sy" type="number" step="1" value="1000"></div>

          <div class="field"><label>Z1</label><input id="Z1" type="number" step="1" value="50"></div>
          <div class="field"><label>Z2</label><input id="Z2" type="number" step="1" value="50"></div>

          <div class="field"><label>Cc1</label><input id="Cc1" type="number" step="0.001" value="0.15"></div>
          <div class="field"><label>Cc2</label><input id="Cc2" type="number" step="0.001" value="0.15"></div>

          <div class="field"><label>Ck1</label><input id="Ck1" type="number" step="0.001" value="1"></div>
          <div class="field"><label>Ck2</label><input id="Ck2" type="number" step="0.001" value="1"></div>

          <div class="field"><label>Cf1</label><input id="Cf1" type="number" step="0.001" value="1"></div>
          <div class="field"><label>Cf2</label><input id="Cf2" type="number" step="0.001" value="1"></div>

          <div class="field"><label>a0 [deg]</label><input id="a0_deg" type="number" step="0.01" value="20"></div>
          <div class="field"><label>ni</label><input id="ni" type="number" step="0.001" value="0.3"></div>

          <div class="field"><label>Cs1</label><input id="Cs1" type="number" step="0.001" value="0.49"></div>
          <div class="field"><label>Cs2</label><input id="Cs2" type="number" step="0.001" value="0.49"></div>

          <div class="field"><label>E_to_sy</label><input id="E_to_sy" type="number" step="0.1" value="200"></div>
          <div class="field"><label>log_Tmid_to_max</label><input id="log_Tmid_to_max" type="number" step="0.01" value="-0.5"></div>

          <div class="field"><label>b_to_m</label><input id="b_to_m" type="number" step="0.1" value="30"></div>
          <div class="field"><label>da12_to_m</label><input id="da12_to_m" type="number" step="0.001" value="0"></div>

          <div class="field"><label>m [mm]</label><input id="m" type="number" step="0.01" value="3"></div>
          <div class="field"><label>Plot y-limits (STĒ)</label><input id="ylims" type="text" value="4,19"></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnRun">Run NN STE</button>
          <button class="btn" id="btnExportCsv">Export returned CSV</button>
        </div>

        <div id="status" class="status" style="margin-top:10px;">Ready.</div>
      </div>
    </section>
  </aside>

  <main class="main">
    <section class="card">
      <div class="head">
        <h2>Results Summary</h2>
      </div>
      <div class="body">
        <div class="badgeRow">
          <div class="badge">conv_factor_bar_to_rad: <strong id="b_conv">—</strong></div>
          <div class="badge">Tmid [N·mm]: <strong id="b_Tmid">—</strong></div>
          <div class="badge">T2 [N·mm]: <strong id="b_T2">—</strong></div>
          <div class="badge">b [mm]: <strong id="b_b">—</strong></div>
          <div class="badge">rg1 [mm]: <strong id="b_rg1">—</strong></div>
          <div class="badge">rg2 [mm]: <strong id="b_rg2">—</strong></div>
        </div>
      </div>
    </section>

    <div class="split">
      <section class="card">
        <div class="head"><h2>Plot 1 — λ vs STĒ (left) and STEφ_mid scale (right)</h2></div>
        <div class="canvasWrap">
          <canvas id="cv1"></canvas>
          <div class="smallnote">
            MATLAB-equivalent πρώτου figure: κύρια καμπύλη <span class="mono">STĒ(λ)</span> και δεξιά άξονας
            με κλίμακα <span class="mono">STEφ_mid [rad]</span> μέσω του ίδιου conversion factor.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>Plot 2 — λ vs STEφ₂ (left) and G (right)</h2></div>
        <div class="canvasWrap">
          <canvas id="cv2"></canvas>
          <div class="smallnote">
            MATLAB-equivalent δεύτερου figure με dual y-axis:
            <span class="mono">STEφ₂(λ)</span> και <span class="mono">G(λ)</span>.
          </div>
        </div>
      </section>
    </div>

    <section class="card">
      <div class="head"><h2>Returned Scalars</h2></div>
      <div class="body" id="scalarTable">
        <div class="kv"><div class="k">No results yet</div><div class="v">—</div></div>
      </div>
    </section>

    <div class="footer">© <span id="year"></span> GEARCALC-PRO — NN surrogate frontend (calls Python backend API)</div>
  </main>
</div>

<script>
(() => {
  "use strict";

  const el = id => document.getElementById(id);
  el("year").textContent = new Date().getFullYear();

  const ui = {
    apiBase: el("apiBase"),
    x_vals_pop: el("x_vals_pop"), sy: el("sy"),
    Z1: el("Z1"), Z2: el("Z2"),
    Cc1: el("Cc1"), Cc2: el("Cc2"),
    Ck1: el("Ck1"), Ck2: el("Ck2"),
    Cf1: el("Cf1"), Cf2: el("Cf2"),
    a0_deg: el("a0_deg"),
    Cs1: el("Cs1"), Cs2: el("Cs2"),
    E_to_sy: el("E_to_sy"), ni: el("ni"),
    log_Tmid_to_max: el("log_Tmid_to_max"),
    b_to_m: el("b_to_m"), da12_to_m: el("da12_to_m"),
    m: el("m"), ylims: el("ylims"),
    btnRun: el("btnRun"), btnExportCsv: el("btnExportCsv"),
    status: el("status"),
    cv1: el("cv1"), cv2: el("cv2"),
    b_conv: el("b_conv"), b_Tmid: el("b_Tmid"), b_T2: el("b_T2"),
    b_b: el("b_b"), b_rg1: el("b_rg1"), b_rg2: el("b_rg2"),
    scalarTable: el("scalarTable")
  };

  let lastResult = null;

  function setStatus(kind, msg){
    ui.status.className = "status " + (kind || "");
    ui.status.innerHTML = msg;
  }

  function fmt(v, nd=6){
    if (!Number.isFinite(v)) return "—";
    return Number(v).toFixed(nd).replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'');
  }

  function parseYlims(text){
    const p = String(text).split(",").map(s => Number(s.trim()));
    if (p.length !== 2 || !isFinite(p[0]) || !isFinite(p[1]) || p[1] <= p[0]) {
      return [4,19];
    }
    return p;
  }

  function getInputs(){
    const req = {
      x_vals_pop: Number(ui.x_vals_pop.value),
      sy: Number(ui.sy.value),
      Z1: Number(ui.Z1.value),
      Z2: Number(ui.Z2.value),
      Cc1: Number(ui.Cc1.value),
      Cc2: Number(ui.Cc2.value),
      Ck1: Number(ui.Ck1.value),
      Ck2: Number(ui.Ck2.value),
      Cf1: Number(ui.Cf1.value),
      Cf2: Number(ui.Cf2.value),
      a0_deg: Number(ui.a0_deg.value),
      Cs1: Number(ui.Cs1.value),
      Cs2: Number(ui.Cs2.value),
      E_to_sy: Number(ui.E_to_sy.value),
      ni: Number(ui.ni.value),
      log_Tmid_to_max: Number(ui.log_Tmid_to_max.value),
      b_to_m: Number(ui.b_to_m.value),
      da12_to_m: Number(ui.da12_to_m.value),
      m: Number(ui.m.value),
      ylimits_plot1_bar: parseYlims(ui.ylims.value)
    };

    for (const [k,v] of Object.entries(req)){
      if (Array.isArray(v)) continue;
      if (!Number.isFinite(v)) throw new Error(`Invalid input: ${k}`);
    }
    if (req.x_vals_pop < 10) throw new Error("x_vals_pop must be >= 10");
    if (req.Z1 < 3 || req.Z2 < 3) throw new Error("Z1, Z2 must be >= 3");
    if (req.m <= 0) throw new Error("m must be > 0");
    if (req.sy <= 0) throw new Error("sy must be > 0");
    return req;
  }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(data)
    });
    const txt = await res.text();
    let json;
    try { json = JSON.parse(txt); } catch { throw new Error(`Non-JSON response: ${txt.slice(0,200)}`); }
    if (!res.ok) throw new Error(json.detail || `HTTP ${res.status}`);
    return json;
  }

  function setupHiDPICanvas(cv){
    const ctx = cv.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const w = cv.clientWidth, h = cv.clientHeight;
    cv.width = Math.round(w*dpr); cv.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);
    return {ctx, w, h};
  }

  function bounds(arr){
    let mn=Infinity, mx=-Infinity;
    for (const v of arr){ if (!isFinite(v)) continue; mn=Math.min(mn,v); mx=Math.max(mx,v); }
    if (!isFinite(mn) || !isFinite(mx)){ mn=0; mx=1; }
    if (Math.abs(mx-mn)<1e-12){ mn-=1; mx+=1; }
    return [mn,mx];
  }

  function drawDualAxisPlot(cv, cfg){
    const {ctx,w,h} = setupHiDPICanvas(cv);
    const x = cfg.x;
    const yL1 = cfg.yLeft1 || null;
    const yL2 = cfg.yLeft2 || null;
    const yR1 = cfg.yRight1 || null;

    if (!x || !x.length || ((!yL1||!yL1.length) && (!yL2||!yL2.length) && (!yR1||!yR1.length))){
      ctx.fillStyle = "rgba(255,255,255,.7)";
      ctx.font = "14px system-ui";
      ctx.fillText("No data yet. Run NN STE.", 18, 28);
      return;
    }

    const rect = { x:70, y:20, w:w-140, h:h-70 };

    const [xmin0, xmax0] = bounds(x);
    let xmin = xmin0, xmax = xmax0;
    const padX = 0.03*(xmax-xmin);
    xmin -= padX; xmax += padX;

    // left-axis bounds from left series
    const leftVals = [];
    if (yL1) leftVals.push(...yL1);
    if (yL2) leftVals.push(...yL2);
    let [yLmin, yLmax] = cfg.leftYRange ? cfg.leftYRange : bounds(leftVals);
    const padYL = cfg.leftYRange ? 0 : 0.08*(yLmax-yLmin);
    yLmin -= padYL; yLmax += padYL;

    // right-axis bounds from right series (or explicit)
    let [yRmin, yRmax] = cfg.rightYRange ? cfg.rightYRange : bounds(yR1 || [0,1]);
    const padYR = cfg.rightYRange ? 0 : 0.08*(yRmax-yRmin);
    yRmin -= padYR; yRmax += padYR;

    const X = v => rect.x + (v-xmin)/(xmax-xmin)*rect.w;
    const YL = v => rect.y + (1-(v-yLmin)/(yLmax-yLmin))*rect.h;
    const YR = v => rect.y + (1-(v-yRmin)/(yRmax-yRmin))*rect.h;

    // bg grid
    ctx.strokeStyle = "rgba(255,255,255,.06)";
    ctx.lineWidth = 1;
    for (let i=0;i<6;i++){
      const a = i/5;
      const px = rect.x + a*rect.w;
      const py = rect.y + a*rect.h;
      ctx.beginPath(); ctx.moveTo(px, rect.y); ctx.lineTo(px, rect.y+rect.h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(rect.x, py); ctx.lineTo(rect.x+rect.w, py); ctx.stroke();
    }
    ctx.strokeStyle = "rgba(255,255,255,.16)";
    ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);

    // title
    if (cfg.title){
      ctx.fillStyle = "rgba(255,255,255,.88)";
      ctx.font = "700 13px system-ui";
      ctx.fillText(cfg.title, rect.x, 14);
    }

    // helpers
    function drawSeries(y, color, yMap, lineWidth=2){
      if (!y || !y.length) return;
      ctx.strokeStyle = color;
      ctx.lineWidth = lineWidth;
      ctx.beginPath();
      let started = false;
      for (let i=0;i<Math.min(x.length,y.length);i++){
        if (!isFinite(x[i]) || !isFinite(y[i])) continue;
        const px = X(x[i]), py = yMap(y[i]);
        if (!started){ ctx.moveTo(px,py); started = true; }
        else ctx.lineTo(px,py);
      }
      ctx.stroke();
    }

    // draw left/right series
    if (yL1) drawSeries(yL1, cfg.left1Color || "rgba(0,0,0,.9)", YL, 2.2);
    if (yL2) drawSeries(yL2, cfg.left2Color || "rgba(255,255,255,.95)", YL, 2.0);
    if (yR1) drawSeries(yR1, cfg.right1Color || "rgba(122,162,255,.95)", YR, 2.2);

    // x ticks
    ctx.fillStyle = "rgba(255,255,255,.72)";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center"; ctx.textBaseline = "top";
    for (let i=0;i<6;i++){
      const a = i/5;
      const xv = xmin + a*(xmax-xmin);
      ctx.fillText(fmt(xv, cfg.xTickDigits ?? 3), rect.x + a*rect.w, rect.y + rect.h + 8);
    }

    // left y ticks
    ctx.textAlign = "right"; ctx.textBaseline = "middle";
    for (let i=0;i<6;i++){
      const a = i/5;
      const yv = yLmax - a*(yLmax-yLmin);
      ctx.fillText(fmt(yv, cfg.leftTickDigits ?? 3), rect.x - 8, rect.y + a*rect.h);
    }

    // right y ticks
    ctx.textAlign = "left";
    for (let i=0;i<6;i++){
      const a = i/5;
      const yv = yRmax - a*(yRmax-yRmin);
      ctx.fillText(fmt(yv, cfg.rightTickDigits ?? 3), rect.x + rect.w + 8, rect.y + a*rect.h);
    }

    // labels
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.textAlign = "center"; ctx.textBaseline = "bottom";
    ctx.fillText(cfg.xlabel || "x", rect.x + rect.w/2, h - 4);

    ctx.save();
    ctx.translate(16, rect.y + rect.h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign = "center"; ctx.textBaseline = "top";
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.fillText(cfg.ylabelLeft || "yL", 0, 0);
    ctx.restore();

    ctx.save();
    ctx.translate(w - 16, rect.y + rect.h/2);
    ctx.rotate(+Math.PI/2);
    ctx.textAlign = "center"; ctx.textBaseline = "top";
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.fillText(cfg.ylabelRight || "yR", 0, 0);
    ctx.restore();

    // legend
    const lx = rect.x + 10, ly = rect.y + 10;
    let k = 0;
    const items = [];
    if (cfg.left1Label && yL1) items.push([cfg.left1Color || "rgba(0,0,0,.9)", cfg.left1Label]);
    if (cfg.left2Label && yL2) items.push([cfg.left2Color || "rgba(255,255,255,.95)", cfg.left2Label]);
    if (cfg.right1Label && yR1) items.push([cfg.right1Color || "rgba(122,162,255,.95)", cfg.right1Label]);

    for (const [c,label] of items){
      const y0 = ly + k*18;
      ctx.strokeStyle = c; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(lx, y0+7); ctx.lineTo(lx+24, y0+7); ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,.82)";
      ctx.textAlign = "left"; ctx.textBaseline = "top";
      ctx.fillText(label, lx+30, y0);
      k++;
    }
  }

  function renderScalarsTable(s){
    const rows = [
      ["da12 [mm]", s.da12],
      ["a12 [mm]", s.a12],
      ["E1 [MPa]", s.E1],
      ["E2 [MPa]", s.E2],
      ["E [MPa]", s.E],
      ["b [mm]", s.b],
      ["rg1 [mm]", s.rg1],
      ["rg2 [mm]", s.rg2],
      ["Tmid_max1 [N·mm]", s.Tmid_max1],
      ["Tmid_max2 [N·mm]", s.Tmid_max2],
      ["Tmid [N·mm]", s.Tmid],
      ["T2 [N·mm]", s.T2],
      ["conv_factor_bar_to_rad", s.conv_factor_bar_to_rad]
    ];
    ui.scalarTable.innerHTML = rows.map(([k,v]) =>
      `<div class="kv"><div class="k">${k}</div><div class="v">${fmt(v, 10)}</div></div>`
    ).join("");
  }

  function updateBadges(s){
    ui.b_conv.textContent = fmt(s.conv_factor_bar_to_rad, 10);
    ui.b_Tmid.textContent = fmt(s.Tmid, 4);
    ui.b_T2.textContent = fmt(s.T2, 4);
    ui.b_b.textContent = fmt(s.b, 4);
    ui.b_rg1.textContent = fmt(s.rg1, 4);
    ui.b_rg2.textContent = fmt(s.rg2, 4);
  }

  function drawPlots(res){
    const x = res.x_vals;
    const yBar = res.STE_bar;
    const yPhi2 = res.STE_phi_2;
    const yG = res.G;
    const s = res.scalars;

    // Plot 1: left = STE_bar, right = STE_phi_mid scale.
    // MATLAB ουσιαστικά βάζει δεξιό άξονα scaled με conv_factor * ylimits.
    const ylimsBar = res.plot1.ylimits_bar;
    const rightRange = [
      s.conv_factor_bar_to_rad * ylimsBar[0],
      s.conv_factor_bar_to_rad * ylimsBar[1]
    ];

    drawDualAxisPlot(ui.cv1, {
      title: "λ vs STĒ  |  right axis = STEφ_mid scale",
      x,
      yLeft1: yBar,
      yRight1: yBar.map(v => v * s.conv_factor_bar_to_rad), // για να φαίνεται και καμπύλη αν θες
      leftYRange: ylimsBar,
      rightYRange: rightRange,
      xlabel: "λ [-]",
      ylabelLeft: "STĒ [-]",
      ylabelRight: "STEφ_mid [rad]",
      left1Label: "STĒ",
      right1Label: "STEφ_mid (= STĒ·conv)",
      left1Color: "rgba(0,0,0,.95)",
      right1Color: "rgba(122,162,255,.95)",
      xTickDigits: 2,
      leftTickDigits: 3,
      rightTickDigits: 6
    });

    // Plot 2: left = STE_phi_2, right = G
    drawDualAxisPlot(ui.cv2, {
      title: "λ vs STEφ₂ and G",
      x,
      yLeft1: yPhi2,
      yRight1: yG,
      xlabel: "λ [-]",
      ylabelLeft: "STEφ₂ [rad]",
      ylabelRight: "G [Nmm/rad]",
      left1Label: "STEφ₂",
      right1Label: "G",
      left1Color: "rgba(0,0,0,.95)",
      right1Color: "rgba(122,162,255,.95)",
      xTickDigits: 2,
      leftTickDigits: 6,
      rightTickDigits: 2
    });
  }

  async function runNN(){
    try{
      const payload = getInputs();
      const base = ui.apiBase.value.trim().replace(/\/+$/,"");
      if (!base) throw new Error("Set API Base URL first.");

      setStatus("warn", "Running NN backend call...");
      ui.btnRun.disabled = true;

      const url = base + "/api/nn/ste-metal";
      const res = await postJSON(url, payload);

      lastResult = res;
      updateBadges(res.scalars);
      renderScalarsTable(res.scalars);
      drawPlots(res);

      setStatus("ok",
        `Done. Returned <span class="mono">${res.x_vals.length}</span> points from backend ` +
        `and computed STE/G curves successfully.`
      );
    } catch(err){
      console.error(err);
      setStatus("bad", `Error: <span class="mono">${String(err.message || err)}</span>`);
    } finally{
      ui.btnRun.disabled = false;
    }
  }

  function exportReturnedCsv(){
    if (!lastResult){
      setStatus("warn","No results yet. Run NN STE first.");
      return;
    }
    const r = lastResult;
    const n = Math.min(r.x_vals.length, r.STE_bar.length, r.STE_phi_mid.length, r.STE_phi_2.length, r.G.length);
    const rows = [["lambda","STE_bar","STE_phi_mid_rad","STE_phi_2_rad","G_Nmm_per_rad"]];
    for (let i=0;i<n;i++){
      rows.push([r.x_vals[i], r.STE_bar[i], r.STE_phi_mid[i], r.STE_phi_2[i], r.G[i]]);
    }
    const csv = rows.map(row => row.join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "nn_ste_metal_results.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("ok","Exported returned curves CSV.");
  }

  ui.btnRun.addEventListener("click", runNN);
  ui.btnExportCsv.addEventListener("click", exportReturnedCsv);
  window.addEventListener("resize", () => { if (lastResult) drawPlots(lastResult); });

  setStatus("", "Ready. Set API Base URL and press Run NN STE.");
})();
</script>
</body>
</html>
